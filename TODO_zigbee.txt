Frostbee - Zigbee TODO
=======================

Status: Dev działa, produkcja wymaga dopracowania


ZMIANY DO COFNIĘCIA DLA PRODUKCJI
---------------------------------

1. [main.c:29] Interwał odczytu sensora
   Dev:  SENSOR_READ_INTERVAL_S = 10
   Prod: SENSOR_READ_INTERVAL_S = 600

2. [main.c:37] Kasowanie NVRAM przy starcie
   Dev:  ERASE_PERSISTENT_CONFIG = ZB_TRUE  (kasuj, rejoin przy każdym bocie)
   Prod: ERASE_PERSISTENT_CONFIG = ZB_FALSE (zachowaj dane sieci)

3. [main.c:253,260] Wymuszanie raportów ZCL
   Dev:  ZB_TRUE (zawsze wysyłaj raport)
   Prod: Rozważyć optymalizację (patrz sekcja RAPORTOWANIE ZCL poniżej)

4. [pm_static.yml] Partycje flash
   Dev:  pm_static.yml (bez ZBOSS NVRAM - zero zapisów do flash)
   Prod: pm_static_release.yml (z ZBOSS NVRAM dla persystencji)

5. [prj.conf] RAM power down
   Dev:  CONFIG_RAM_POWER_DOWN_LIBRARY wyłączone (bezpieczne dla bootloadera)
   Prod: prj_release.conf z CONFIG_RAM_POWER_DOWN_LIBRARY=y

6. [prj.conf] Logi/Serial
   Dev:  CONFIG_LOG=y, CONFIG_SERIAL=y (debug)
   Prod: prj_release.conf z CONFIG_LOG=n, CONFIG_SERIAL=n (oszczędność baterii)


BRAKUJĄCE FUNKCJE
-----------------

[ ] Bateria - atrybut batteryPercentageRemaining
    - Zigbee2MQTT próbuje skonfigurować raportowanie ale dostaje UNSUPPORTED_ATTRIBUTE
    - Trzeba dodać atrybut do ZB_ZCL_DECLARE_POWER_CONFIG_ATTRIB_LIST w main.c
    - Obecnie zadeklarowane: battery_voltage, battery_size, battery_quantity,
      battery_rated_voltage, battery_alarm_mask, battery_voltage_min_threshold
    - Brakuje: battery_percentage (batteryPercentageRemaining, attr ID 0x0021)


JAK BUDOWAĆ
-----------

Development (domyślne):
  west build -b nrf52840dongle/nrf52840 app

Produkcja (gdy gotowe):
  west build -b nrf52840dongle/nrf52840 app -- \
    -DOVERLAY_CONFIG=prj_release.conf \
    -DPM_STATIC_YML_FILE=pm_static_release.yml


RAPORTOWANIE ZCL - DO NAPRAWY
-----------------------------

Status: Obecnie używamy "hacka" z ZB_TRUE który wymusza raport przy każdym
        ZB_ZCL_SET_ATTRIBUTE. To działa, ale nie jest zgodne ze specyfikacją.

Problem: ZB_FALSE nie wysyła raportów - wartości są w pamięci, ale koordynator
ich nie dostaje (Z2M nie polluje sleepy end devices).

Obecne rozwiązanie (hack):
  - ZB_ZCL_SET_ATTRIBUTE(..., ZB_TRUE) wymusza raport
  - Działa, ale wysyła raport nawet gdy wartość się nie zmieniła
  - Nie respektuje Configure Reporting od koordynatora

Prawidłowe rozwiązanie (do zaimplementowania):
  1. Upewnić się że atrybuty mają flagę ZB_ZCL_ATTR_ACCESS_REPORTING
  2. Koordynator (Z2M) wysyła "Configure Reporting" do urządzenia
     - np. "raportuj temperaturę co 60-300s gdy zmieni się o 0.5°C"
  3. ZBOSS reporting engine automatycznie wysyła raporty
  4. ZB_ZCL_SET_ATTRIBUTE(..., ZB_FALSE) - tylko ustawia wartość

Kroki do naprawy:
  [ ] Sprawdzić czy atrybuty temp/humidity mają ACCESS_REPORTING
  [ ] Sprawdzić logi Z2M czy Configure Reporting przechodzi bez błędów
  [ ] Przetestować z ZB_FALSE po naprawie
  [ ] Zweryfikować że raporty idą tylko gdy wartość zmieni się o próg

Alternatywa - ręczne raportowanie z progiem:
  - Sprawdzać czy wartość zmieniła się o np. 0.5°C / 2% RH
  - Jeśli tak - wywołać zb_zcl_report_attr() ręcznie
  - Najefektywniejsze dla baterii, ale wymaga więcej kodu


NOTATKI
-------

- Bootloader UF2 jest chroniony w regionie 0xd8000-0x100000 (160 KB reserved)
- Kanał Zigbee: multi-channel scan (CONFIG_ZIGBEE_CHANNEL_SELECTION_MODE_MULTI=y)
- Device ID: ZB_HA_TEMPERATURE_SENSOR_DEVICE_ID
- Endpoint: 1
- Manufacturer: "Frostbee", Model: "FBE_TH_1"
